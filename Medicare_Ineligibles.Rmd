---
title: "Impact of providing ART to Medicare ineligibles"
author: "Richard T. Gray"
date: Latest version - `r format(Sys.Date(), format="%B %d %Y")` <!---Add date automatically  using R whenever markdown is run! --->
output:
  word_document:
    reference_docx: docs/mystyles.docx
    pandoc_args: [--output="docs/Medicare_Ineligibles.docx"]
bibliography: docs/medicare_ineligibles.bib
csl: docs/plos.csl
---

This document summarises a simple analysis to calculate the impact of providing anti-retroviral therapy (ART) for free to people living with HIV (PLHIV) in Australia who are medicare ineligible. This analysis uses data from the Australian HIV Obserbvational Database Temporary Residents Access Study (ATRAS) [@petoumenos2013australian].The R code for these calculations is available in the associated Rmarkdown file.

This document is written in dynamic format using R markdown v2 within R studio 0.98.1056 (using R version 3.1.2). Plots are created using the package ggplot2. Further details are available in the associated R markdown file which also contains the R code to produce all the results when the markdown is run. Code blocks have been supressed in the output document. <!--- The document was currently produced using R markdown v2 within Rstudio using `r substr(R.Version()$version.string,1,15)`, knitr, pandoc, and Miktex (for Latex) for producing the associated PDF or Word Document output. The analysis uses the R packages ggplot2, reshape, gridExtra. To update the results the markdown file needs to be loaded in Rstudio or run using the tools separately. ---> 

```{r initialization,echo = FALSE,messages = FALSE,include=FALSE}
# Clear workspace
rm(list=ls()) 
options(scipen=999)  # To get rid of scientific notation

# Load libraries use in the analysis.
require(ggplot2)
require(reshape2)
require(gridExtra)
require(Hmisc)

# Before we get started set some overarching variables so we can rerun results instead of generating new ones if necessary. Store outputs 
# and initialize other script wide varuables.
outputFolder <- "output"
docFolder <- "docs"
currTime <- format(Sys.time(), "%y-%m-%d %H-%M-%S") # For appending to output files

# Specifications for loading previously generated results or saving results to file. The basic format of a file string 
# is date and time + a file tag + " Inputs" or " Results".R. The defaults are set to FALSE and the user has to manually
# specifify the file to load. This is set up so long simulation runs do not need to be repeated to generate the dcoument. 

loadFileTag <- "output/15-02-04 16-08-42 Draft" # Set to empty to run things a fresh. Manually enter file name tag to regenerate old results. 
                  # loadFileTag has the structure of date and time + a file tag " Input.R" and " Results.R" are appended later.
loadVars <- TRUE # Set to FALSE to run things a fresh.
loadResults <- TRUE # Set to FALSE to run things a fresh. If TRUE a corresponding input file needs to exist and is loaded as well.
useSeed <- FALSE  # Use seed in loadVars file to get exactly the same results.

saveFileTag <- " Draft"  # Tag for output file names to specify scenarios
saveVars <- FALSE       # Save input parameters so tehn can be loaded separately
saveResults <- FALSE    # If TRUE saveVars is assumed TRUE as well. 

# Check if output directories exist and create if necessary
if (!file.exists(outputFolder)){dir.create(file.path("./",outputFolder))}
if (!file.exists(docFolder)){dir.create(file.path("./",docFolder))}

# Produce plots in windows for viewing separately and save plots separately.
showPlots <- TRUE   # Show plots in separate windows
savePlots <- FALSE  # Save plots to file
knitplots <- TRUE  # Insert plots in the produced Rmarkdown document

```

### Methodogy 

This section summarises the methodology used for the calculations. A simple mathematical model is used to caluclate the change in population size over time and the number of new infections in partners of medicare ineligible people. Model details, assumptions and input parameters are described below.

```{r SimVariables,echo=FALSE}
if (!loadVars || !loadResults){
  # If not loading from previously created file specifiy inputs
  # Initialize parameters for running calculations
  startyear <- 2011 # year ATRAS started represents year zero
  datayears <- 3 # Number of years we have data - year zero and 2 years of followup. 
  runyears <- 6  # Number of years to run the model. Short term 5 to 10.
  numsims <- 1000  # Number of sampled parameter sets to run
  stochastic <- TRUE # Run stochastic equations?
  stochasticSims <- 20 # Number of sims for each parameter set if stochastic calculations are set-up
  
  # Generate and store a random integer for set.seed so we can rerun things exactly if we want to
  currseed <- sample(1:10^6,1)
  set.seed(currseed)
  
} else {
  # Save current values of some params as they will be replaced
  oldloadFileTag <- loadFileTag; oldloadVars <- loadVars; oldloadResults <- loadResults; olduseSeed <- useSeed
  oldsaveFileTag <- saveFileTag; oldsaveVars <- saveVars; oldsaveResults <- saveResults; oldshowPlots <- showPlots
  oldsavePlots <- savePlots; oldknitplots  <- knitplots
  
  # Load the file with the saved input parameters
  load(paste(loadFileTag," Inputs.R",sep=""))
       
  # Overwite the input file script variables with their current values. 
  loadFileTag <- oldloadFileTag; loadVars <- oldloadVars; loadResults <- oldloadResults; useSeed <- olduseSeed
  saveFileTag <- oldsaveFileTag; saveVars <- oldsaveVars; saveResults <- oldsaveResults; showPlots <- oldshowPlots
  savePlots <- oldsavePlots; knitplots  <- oldknitplots
}
```

#### Demographics

For this analysis we consider a population of PLHIV who are medicare ineligible with the characteristics of people in ATRAS [@petoumenos2013australian]. The overall population is split into heterosexual males and females, and males who are gay, bisexual or men who have sex with men (GBM). We assume females do not engage in sex work and the population does not include people who inject drugs (PWID). The porportion of people in each of these populations is based on ATRAS data and assumed to be constant over time. This comparmentalisation of the population is used to distinguish the risk of HIV infection rather than treatment coverage and adherence.
<!--- maybe reword and soften no change in behaviour assumption --->

The number of medicare ineligibles can change over time with people becoming eligible for medicare provided ART and new temporary residents entering the population. This movement is represented by a constant grwoth rate for the population $\pi$ (which is positive for a growing population and negative for a declining population). In ATRAS aproximately 20% of people become medicare eligible and leave the population each year, this would be lower bound on the rate of population change. Letting $N(y)$ equal the total population size in year $y$, the number of medicare ineligible people in the population is then given by
$$N(y) = N(0)\pi^y,$$.

#### Clinical characteristics

The main aim of this analysis is to investigate the impact on HIV transmission of providing all medicare ineligible people in ATRAS with ART. For the calculations we simply consider the proportion of the population taking ART and the proportion of those on ART with viral suppression. Both of these inputs can change over time based on the ATRAS data. We do not consider different proportions for each population group. The most recent data value is used for projections beyond the years of available data. 

#### HIV transmission to partners

HIV transmission occurs through sexual intercourse between medicare ineligibles and their sexual partners. We assume initiating ART does not change sexual behaviour and the number of partnerships, sexual acts per partnership, and the level of condom use is similar to the overall Medicare eligible population in Australia - with behavioural parameters estimated using date from the Second Australian Study of Health and Relationships [@pitts2014introduction]. We also do not consider onward transmission from newly infected partners. As the sexual behaviour for the ART and non-ART population is the same, we use a simple risk equation approach with behavioural parameters set to reflect the overall annual risk of transmission rather than incorporating different partnership types and more complex sexual behaviours. 

Key assumptions:

* All sexual partners are HIV negative.
* Homogeneous mixing is assumed which means partnerships are not maintained from year to year.
* HIV transmission only occurs through sexual intercourse.
* There is no difference in sexual behaviour between those on and off ART. Hence, the only factor affecting HIV transmission is ART use and viral suppression.
* Those with unsuppressed virus have the same transmission risk as those not taking ART.
* Females and males have the same number of partners, sexual acts, and condom use on average.
* Females and males have the same sexual behaviour as males and females in the general heterosexual population in Australia.
* Behavioural and transmission parameters are assumed constant over time.
* GBM are exclusively homesexual.

#### Costs associated with ART provision

Our analysis includes an estimate of the annual cost of providing ART, care and support to Medicare ineligibles and their partners who become infected. We obtained estimates of the costs of providing treatment and care to Medicare ineligibles using previous work for Australian settings [@schneider2014cost]. For sexual partners of Medicare ineligibles we estimate the 'lifetime' cost of providing care and treatment using estimates from the the United States [@schackman2006lifetime] (which were the only estimates available). 
<!--- Cost per infection averted. Maybe look up old reports --->

#### Parameter table
Table 1 lists all input parameters and their values and ranges.

```{r inputParameters,echo=FALSE}
# If not loading from previously created file specifiy inputs
if (!loadVars && !loadResults){
  # R code to define parameters for simulations. These are defined as uniform ranges [minimum, best guess, maximum]
  # Next version may read this is from an external file. Samples are randomly obtained from these ranges and put into
  #matrices to aid vectorised calculations
  
  # Demographics
  popsize <- c(400,450,500);   
  pop_growth <- c(0.98,1,1.02); # Overall relative change in population size
  prop_f <- c(0.2,0.25,0.3);   
  prop_m <- c(0.2,0.23,0.3);   
  # porportion of GBM prop_g is calculated internally so that the proportions add up to 1.
   
  # Clinical parameters
  # As these values can change of time we use hardcoded data values from ATRAS to track their change over time. 
  # Uncertainty or variation in these values is assumed to be the same over time and have the same relative factor.
  # Next version may read this is from an external file.
  
  prop_art_base <- c(0.63, 0.95,0.95) # Hard coded
  prop_vs_base <- c(0.7,0.88,0.96) # Hard coded
  
  prop_art_factor <- c(0.95, 1.05) # Uncertainty in proportion not on ART so we don't get a proportion greater than 1 
  prop_vs_factor <- c(0.95, 1.05)  # Uncertainty in proportion not on ART so we don't get a proportion greater than 1 
  
  # Behavioural paramters
  # Assumed to remain cosntant over time
  
  heteroacts <- c(60, 80, 100)     # Number of heterosexual acts per year with partners
  heterocondom <- c(0.15,0.225,0.3)   # Proportion of heterosexual acts where condoms have been used 
  gbmacts <- c(20,40,60)           # Number of homosexual acts per year with partners
  gbmcondom <- c(0.5, 0.575, 0.65)    # Proportion of homosexual acts where condoms have been used
  
  # HIV transmission parameters
  # Assumed to remain constant over time
  
  betaf <- c(0.0001, 0.0004, 0.0014)  # Female to male per unprotected act transmission probability
  betam <- c(0.0006, 0.0008,0.0011)  # Male to female per unprotected act transmission probability
  betag <- c(0.01, 0.014,0.019)       # GBM male to male per unprotected act transmission probability
  
  epsilon_condom <- c(0.8, 0.95, 0.975) # Efficacy of condoms
  epsilon_art <- c(0.9, 0.95, 0.99)   # Reduction in HIV infectiouness due to viral suppression
  
  # Healthcare and ART costs
  
  # ATRAS CD4 data at baseline
  base350 <- 0.439   # Proportion with CD4 greater than 350 at baseline
  base200350<- 0.294 # Proportion with CD4 between 200 and 350 at baseline  
  base200 <- 0.167   # Proportion with CD4 less than 200 at baseline
  baseMissing <- 0.1 # Proportion with missing CD4 at baseline. Used to normalise basline CD4 values 
  
  # Annual medical costs by CD4 count
  careCost350 <- 4000     # Combiination of cost for CD4 > 500 and CD4 between 350 and 500.
  careCost200350 <- 4800  # Medical costs for CD4 between 200 and 350
  careCost200 <- 7900     # Medical costs for CD4 < 200
  
  # Weighted average care cost
  careCostBase <- careCost350*base350/(1-baseMissing) + careCost200350*base200350/(1-baseMissing) + careCost200*base200/(1-baseMissing)
  
  carecost <- c(0.75*careCostBase, careCostBase, 1.25*careCostBase)  # Assumed +/- 25% range
  artcost <- c(7000,11000,15000)                # Assumed everyone is on first line ART
  lifecost <- c(0.75*620000,620000,1.25*620000) # Undicsounted lifetime cost of providing care and ART 
  
  # Save all the internal variables and parameter values 
  if (saveVars || saveResults){
    save(list = ls(all = TRUE), file = paste(outputFolder, "/", currTime, saveFileTag, " Inputs.R", sep =""))
  }
}
```


**Table 1** - Calculation input parameter ranges. Justifications for these parameter ranges are provided in endnotes. The simulations used for the calculations take samples from these ranges assuming a uniform distribution. 

Parameter  | Description                | Range                                        | Endnote justification
-----------|----------------------------|----------------------------------------------|----------------------
**Demographic parameters** | | |    
$N(0)$   | Overall population size in initial year (2014) |  [`r popsize[1]` - `r popsize[3]`] | 1        
$\pi$ | Multaplicative change in annual population | [`r pop_growth[1]` - `r pop_growth[3]`]/yr | 1            
$p_f$ | Proportion of population female | [`r prop_f[1]` - `r prop_f[3]`] | 1
$p_m$ | Proportion of population heterosexual male |  [`r prop_m[1]` - `r prop_m[3]`] | 1  
$p_g$ | Proprtion of population who are GBM | Given by $1-p_f-p_m$ | 1  
**Clinical parameters** | | | 
$\theta$ | Proportion of population taking ART | ATRAS data $\pm$ 5%| 2  
$\psi$ | Proportion of population taking ART with undetectable viral load | ATRAS data $\pm$ 5% | 2  
**HIV behavioural parameters** | | | 
$a_h$ | Annual number of heterosexual acts between females and males| [`r heteroacts[1]` - `r heteroacts[3]`] | 3  
$p^c_h$ | Proportion of heterosexual acts protected with a condom |  [`r heterocondom[1]` - `r heterocondom[3]`] | 4  
$a_g$ | Annual number of sexual acts with other GBM |  [`r gbmacts[1]` - `r gbmacts[3]`]| 5  
$p^c_g$ | Proportion of GBM acts protected with a condom |  [`r gbmcondom[1]` - `r gbmcondom[3]`]| 6  
**HIV transmission paramaters** | | | 
$\beta_f$ | Per act transmission probability from females to males |  [`r betaf[1]` - `r betaf[3]`]| 7  
$\beta_m$ | Per act transmission probability from males to females |  [`r betam[1]` - `r betam[3]`]| 7  
$\beta_g$ | Per act transmission probability between GBM |  [`r betag[1]` - `r betag[3]`]| 7  
$\epsilon_c$ | Efficacy of condoms |  [`r epsilon_condom[1]` - `r epsilon_condom[3]`]| 8  
$\epsilon_{ART}$ | Efficacy of ART in preventing HIV transmission if virus is suppressed | [`r epsilon_art[1]` - `r epsilon_art[3]`]| 9  
**Healthcare costs** | | | 
$c_{care}$ | Average annual healthcare for cost for PLHIV | [\$`r formatC(carecost[1],format="d",big.mark=',')` - \$`r formatC(carecost[3],format="d",big.mark=',')`] | 10  
$c_{ART}$ | Avergae annual cost of providing ART | [\$`r formatC(artcost[1],format="d",big.mark=',')` - \$`r formatC(artcost[3],format="d",big.mark=',')`] | 11  
$c_{life}$ | Average lifetime cost of providing healthcare (including ART) post infection | [\$`r formatC(lifecost[1],format="d",big.mark=',')` - \$`r formatC(lifecost[3],format="d",big.mark=',')`] | 12  


1. The 2013 ATRAS report <!--- data for 2011-12 when ATRAS started. Up to 460 in 2014 ---> estimates there are 450 Medicare ineligible PLHIV in Australia [@petoumenos2013australian]. We assume a range in the population between 400 and 500 PLHIV with the potential for only a small change in population size over time. In the population of 180 at enrolment there were 47 females and 133 males in the cohort with 89 of the males attributing their HIV infection to MSM exposure [@petoumenos2013australian]. Assuming the same demographic distribution over time, we assume 20-30% of the population is female, another 20-30% of the population are male heterosexuals with the remainder GBM.  
2. At enrolment 62.8% of ATRAS patients were already receiving ART with 71.8% having undetectable viral load [@petoumenos2013australian]. After  enrolment all patients were put onto ART resulting in 87% having undetectable viral load at 12 months and 96% having undetectable viral load at 24 months [@petoumenos2013australian]. Based on the ATRAS data we assume the percenatge of Medicare ineligibles on ART increases from 70% to 95% with a range of $\pm$ 5% with the proportion with undetecvtable virus increasing from 70% to 96% over two years with a range of $\pm$ 5%.   
3. The Second Australian Study of Health and Relationships reported heterosexual men had an average of 1.4 partners in the previous year (95% CI: 1.3-1.4; median 1) and heterosexual women had an average of 0.98 partners in the previous year (95% CI: 0.95-1; median 1) [@rissel2014heterosexual]. Seventy four percent of all respondents were in a regular partnership (equal to 89% of those sexually active). On average those in a regular pertnership had vaginal intercourse 1.42 times per week (95% CI: 1.34-1.50). This gives a range of 0.95 x 0.9 x 1.34 x 52 = 59.6 to 1.4 x 0.9 x 1.5 x 52 = 98.3 heterosexual acts per year. Based on this data and calculations we assume a range of [`r heteroacts[1]` - `r heteroacts[3]`] acts per year.   
4. The Second Australian Study of Health and Relationships reported 25.5% and 21.1% of men and women respectively used a condom during most recent sexual encounter involving vaginal sex [@de2014safer]. Based on this data we assume a range of 
[`r 100*heterocondom[1]` - `r 100*heterocondom[3]`]%.   
5. The Second Australian Study of Health and Relationships reported homosexual men had an average of 6.8 partners in the previous year (95% CI: 5.1-8.5; median 3). Twenty eight percent of homosexual men were in a regular homosexual relationship which we assume involves 1-2 acts of anal intercourse per week with the remaining partnerships being casual with 1-2 acts of anal intercourse per partnership. In terms of sexual acts this data suggests an estimate  0.28 x 2 x 52 = 30 regular acts per year and 6.5 x 2 = 13 casual acts per year - assuming 2 acts of anal intercourse per week for regular partnerships and 2 acts of anal intercourse per casual partner. Based on this data and calculations we assume a range of  [`r gbmacts[1]` - `r gbmacts[3]`].
6.  The Second Australian Study of Health and Relationships reported 56.7% and 58.9% men engaging in homosexual behaviour used a condom when they last engaged in insertive and receptive anal sex, respectively. Based on this data we assume a range of [`r 100*gbmcondom[1]` - `r 100*gbmcondom[3]`]%.    
7. The estimated range for the probaility of HIV transmission through penile-vaginal and anal intercourse are based on systematic reviews and meta-analysis of pooled estimates of female-to-male and male-to-female vaginal transmission and for receptive and insertive anal intercourse [@Boily2009a; @patel2014estimating; @Jin2010].  
8. This is the per-act reduction in transmission when a condom is used correctly during intercourse. The range we use is based on the results of numerous reviews [@Pinkerton1997; @Weller2002; @holmes2004effectiveness] and accounts for the small risk of slippage and breakage[@Reece2008].   
9. We assume those with viral suppression have a 96% reduction in transmission to their sexual partners in line with the results from the HPTN-052 trial for those with detectable drug [@cohen2011prevention].         
10. In a recent paper evaluating the cost effectiveness of PrEP interventions in Australia, Scheider et. al. [@schneider2014cost] provide estimates with ranges of annual medical costs for PLHIV based on their CD4 count: Medical at CD4 $\geq$ 500 cells/$\mu$L, \$3,097 
(\$1,274-\$7,642); Medical at CD4 350-499 cells/$\mu$L, \$4,402 (\$1,473-\$11,672); Medical at CD4 200-349 cells/$\mu$L, \$4,762 (\$1,833-\$12,032); and Medical at CD4 $<$ 200 cells/$\mu$ L, \$7,883(\$2,465-\$42,400). The baseline ATRAS data provides the proportion of patients in each CD4 category: percentage CD4 $\geq$ 350 cells/$\mu$L, 43.9%; percentage CD4 between 200 and 350 cells/$\mu$L, 29.4%; and percentage CD4 $<$ 200cells/$\mu$L, 16.7% (with 10% missing). Based on these cost estimates and the ATRAS data (adjusted for missing values) we use an annual medical cost estimate = \$`r careCost350` x `r base350`/(1-`r baseMissing`) + \$`r careCost200350` x `r base200350`/(1-`r baseMissing`) + \$`r careCost200` x \$`r base200`/(1- `r baseMissing`) which gives  a value of \$`r careCostBase`.  We assume a range of $\pm$ 25%.      

11.At enrolement 83% of the ATRAS cohort on ART were taking Tenofovir/Emtrcitabine (Truvada) as the 'backbone' of their regime. This means the vast majority of those on treatment are taking first-line drugs. For this analysis we assume all patients are on and remain on first-line ART over the period of analysis. From Scheider et. al. the average annual cost of first-line drugs is $10,685 ($6,945-$14,424) [@schneider2014cost]. Using this value we assume a range in the annual ART cost of \$`r artcost[1]-artcost[3]`. Note Scheider et. al. estimate annual drug costs for third and higher lines of ART to be greater than $28,000 per year. <!--- may need revision ASR suggests \$16,000 per patient --->
12. If a partner of a Medicare ineligible becomes infected with HIV then they will require care and eventually treatment while they are living in Australia. As we are not tracking their infection progression in this analysis we use an estimate for the lifetime cost of providing care and treatment. We found no data specifically for Australia, however, Schackman et al estimated the lifetime cost of HIV care in the United States in 2006 at \$618,900 USD (undiscounted) for adults who initiate ART with CD4 $<$ 350 cells/$\mu$ L with a life expectancy of 24.2 years [@schackman2006lifetime]. While pharmaceuticals are priced at a premium compared to Australia, this cost equates to \$25,000 (undiscounted) per year of living with HIV which is comparable to the costs presented in endnote 11. For this analysis we use a value of \$620,000 for the lifetime cost of caring and treating someone who becomes infected with HIV and assume a range of $\pm$ 25%.


```{r vectoriseParams, echo = FALSE,  messages = FALSE}

# if (!loadResults){
  # Convert parameters to vectors and matrices for running in the calculations. Constants are stored as vectors and time varying 
  # parameters are stored as matrices. Each vector element or matrix row represents a specific sampling from the input parmater ranges. 
  
  if (useSeed){
    set.seed(currseed)
  } else {
    set.seed(NULL)
  }
  
  # Demograhic parameters - Population size calulated by combining the initial population size and growth rate. As it is time varying 
  # population size is stored as a matrix
  popsizemat <- matrix(0,numsims,runyears)
  for (ii in 1:numsims){
    popsizemat[ii,] <- runif(1,popsize[1],popsize[2]) * runif(1,pop_growth[1],pop_growth[2])^c(1:runyears)
  }
  
  prop_fvec <- runif(numsims,prop_f[1],prop_f[3])
  prop_mvec <- runif(numsims,prop_m[1],prop_m[3])
  
  # Clinical parameters (matrices). This is done by first converting proportions on ART and with viral suppression to vectors of 
  # equal length to number of simulation years and then inverting twice so the uncertianty factor does not produce a value great than 1. 
  # If the number of simulations years is greater than the number of data values the final data value is assumed to remain constant.
  
  prop_art_baseVec <- prop_art_base[length(prop_art_base)] * rep(1,runyears)
  prop_art_baseVec[1:length(prop_art_base)] <- prop_art_base  # Replace start of vector with data values
  
  prop_vs_baseVec <- prop_vs_base[length(prop_vs_base)] * rep(1,runyears)
  prop_vs_baseVec[1:length(prop_vs_base)] <- prop_vs_base  # Replace start of vector with data values
  
  
  # Now create matrix of values by looping over number of simulations
  prop_art_basemat <- matrix(0,numsims,runyears)
  prop_vs_basemat <- matrix(0,numsims,runyears)
  for (ii in 1:numsims) {
     # Sample from multiplicative factor
    tempFactor_art <- runif(1,prop_art_factor[1],prop_art_factor[2]) 
    tempFactor_vs <- runif(1,prop_vs_factor[1],prop_vs_factor[2])
  #   
    # Do double inversion and store in the row
    prop_art_basemat[ii,] <- 1-tempFactor_art * (1-prop_art_baseVec)
    prop_vs_basemat[ii,] <- 1-tempFactor_vs * (1-prop_vs_baseVec)
  }
  
  # Behavioural paramaters (vectors)
  heteroactsvec <- runif(numsims,heteroacts[1],heteroacts[3])
  heterocondomvec <- runif(numsims,heterocondom[1],heterocondom[3])
  gbmactsvec <- runif(numsims,gbmacts[1],gbmacts[3])
  gbmcondomvec <- runif(numsims,gbmcondom[1],gbmcondom[3])
  
  # Transmission parameters (vectors)
  betafvec <- runif(numsims,betaf[1],betaf[3])
  betamvec <- runif(numsims,betam[1],betam[3])
  betagvec <- runif(numsims,betag[1],betag[3])
  
  epsilon_condomvec <- runif(numsims,epsilon_condom[1],epsilon_condom[3])
  epsilon_artvec <- runif(numsims,epsilon_art[1],epsilon_art[3])
  
  # Cost parameters
  costcarevec <- runif(numsims,carecost[1],carecost[3])
  costartvec <-  runif(numsims,artcost[1],artcost[3])
  costlifevec <- runif(numsims,lifecost[1],lifecost[3])

# } else {
#   # Load previously generated results
#   load(paste(loadFileTag," Results.R",sep=""))
# }


````

#### Calculations for new infections and costs

The overall number of new infections per year is calculated by summing the number of new infections caused by each population group; i.e., $$I(y) = I_f(y) + I_m(y) + I_g(y),$$ where $y$ is the given year.

Letting the index $x$ represent one of the populations groups (and droping $y$ for the time being), the probability of HIV transmission without ART is given by 
$$\beta'_x = a_x(1-p^c_x)\beta_x + a_x p^c_x (1- \epsilon_c)\beta_x$$ or 
$$\beta'_x = a_x (1-p^c_x\epsilon_x)\beta_x.$$ For $x = f$, $m$ the number of acts and condom use are equal and given by the index $h$. Similarly we can incorporate the prevention effects of treatment and suppressed virus, to give the probability of transmission to a HIV-negative sexual partner 
$$\beta''_x = p_x[(1-\theta)\beta'_x + \theta(1-\psi)\beta'_x + \theta\psi(1-\epsilon_{ART})\beta'_x]$$ 
as ineffective treatment (resulting in unsuppressed virus) has the same transmission probability as no treatment. After some algebra this gives
$$\beta''_x = (1-\theta\psi\epsilon_{ART})\beta'_x = a_x(1-p^c_x\epsilon_x)(1-\theta\psi\epsilon_{ART})\beta_x.$$ 

Using this probability we can the number of new infections each year $I_x$ is given by a binomial distribution
$$I_x \sim binom(Np_x,\beta''_x).$$ 
For large N and $\beta''_x$ this is approximately equal to 
$$I_x = Np_x\beta''_x = Np_xa_x(1-p^c_x\epsilon_x)(1-\theta\psi\epsilon_{ART})\beta_x,$$ 
and the number of new infections is given by a risk equation. <!--- In the Rmarkdown script there is an option to use the risk equation approach instead of the sampling from a binomial disytribution ---> Given the relatively small population size and the high levels of ART coverage and viral suppression, likely resulting in a small  number so infections, we use the stochastic approach in this anaylsis. 

Adding all the population terms together gives the overall number of new infections $I(y)$ in a given year $y$. The cumulative number of new infections in partners of medicare ineligibles over $y$ years is then equal to
$$\Sigma = \sum_{y = 1}^{years} I(y).$$

The total cost of providing ART and healthcare to Medicare ineligibles is then given by
$$\sum_{y = 1}^{years} (N(y)(c_{care} + \theta c_{ART})$$
and the future costs of providing care and treatment to newly infected partners of Medicare ineligibles is
$\Sigma c_{life}$.

#### Simulations

To perform this analysis, we generated `r numsims` input parameter sets by sampling from each of the parameter ranges in Table 1. For each of these parameter sets we then ran `r stochasticSims` simulations to account for stochastic variations. Each simulation was ran for `r runyears` since the enrolment of patients into ATRAS. Summary statistics were then calculated using the results from each simulation.  

```{r functions,echo = FALSE, messages = FALSE}
# Define two functions to calculate the incidence for a population. The second function can either be stocastic or deterministic
infect_prob <- function(acts,propcondom,effcondom,propart,propvs,effart,beta){
  return(acts*(1-propcondom*effcondom)*(1-propart*propvs*effart)*beta)
#   return((1-(1-(1-effcondom)*beta)^(acts*propcondom)*(1-beta)*(acts*(1-propcondom))*(1-propart*propvs*effart)))
#    return((1-(1-(1-propcondom*effcondom)*beta)^acts)*(1-propart*propvs*effart))
}

popinfects <- function(popsize,prob,stochastic = FALSE){
  if (!stochastic){
    return(popsize *prob)
  } else {
    return(rbinom(length(prob),round(popsize),prob))
  }
  
}
```

```{r calculations, echo=FALSE, messages = FALSE, include = FALSE}
if (!loadResults){
  # We are now ready to run the code that actually does the calculations for each simulation. This involves looping through each parameter
  # set and calculating the incidence for each population using the current data and the counterfactual levels. <- Using the sampled and
  # best fitting estimates and just the median of all values?? -->
  
  # Determine how many runs to do for each parameter set
  if (stochastic){
    numruns <- stochasticSims
  } else {
    numruns <- 1
  }
  
  # Initialize output arrays
  paramSet <- vector()
  
  # For ATRAS simulations
  infectsm <- matrix(0,numsims*numruns,runyears)
  infectsf <- matrix(0,numsims*numruns,runyears)
  infectsg <- matrix(0,numsims*numruns,runyears)
  costAtras <- matrix(0,numsims*numruns,runyears)
  
  # For baseline simulations
  infectsmBase <- matrix(0,numsims*numruns,runyears)
  infectsfBase <- matrix(0,numsims*numruns,runyears)
  infectsgBase <- matrix(0,numsims*numruns,runyears)
  
  # Do the calculations
  for (ii in 1:numsims){
  
    for (jj in 1:numruns){
      # Row index for storage in output matrices
      vecIndex <- (ii-1)*numruns + jj
      
      # Store parameter set index
      paramSet <- c(paramSet,ii*matrix(1,runyears,1))
       
      # Infections casued by hetero males - ATRAS
      infectsm[vecIndex,] <- popinfects(popsizemat[ii,]*prop_mvec[ii],infect_prob(heteroactsvec[ii],heterocondomvec[ii],
                      epsilon_condomvec[ii],prop_art_basemat[ii,],prop_vs_basemat[ii,],epsilon_artvec[ii],
                      betamvec[ii]),stochastic)
    
      # Infections casued by hetero males - Baseline
      infectsmBase[vecIndex,] <- popinfects(popsizemat[ii,]*prop_mvec[ii],rep(infect_prob(heteroactsvec[ii],heterocondomvec[ii],
                      epsilon_condomvec[ii],prop_art_basemat[ii,1],prop_vs_basemat[ii,1],epsilon_artvec[ii],
                      betamvec[ii]),runyears),stochastic)
      
      # Infections casused by hetero female - ATRAS
      infectsf[vecIndex,] <- popinfects(popsizemat[ii,]*prop_fvec[ii],infect_prob(heteroactsvec[ii],heterocondomvec[ii],
                      epsilon_condomvec[ii],prop_art_basemat[ii,],prop_vs_basemat[ii,],epsilon_artvec[ii],
                      betafvec[ii]),stochastic)
      
      # Infections casused by hetero female - Baseline
      infectsfBase[vecIndex,] <- popinfects(popsizemat[ii,]*prop_fvec[ii],rep(infect_prob(heteroactsvec[ii],heterocondomvec[ii],
                      epsilon_condomvec[ii],prop_art_basemat[ii,1],prop_vs_basemat[ii,1],epsilon_artvec[ii],
                      betafvec[ii]),runyears),stochastic)
      
      
      # Infections caused by GBM - ATRAS
      infectsg[vecIndex,] <- popinfects(popsizemat[ii,]*(1-prop_mvec[ii]-prop_fvec[ii]),infect_prob(gbmactsvec[ii],gbmcondomvec[ii],
                      epsilon_condomvec[ii],prop_art_basemat[ii,],prop_vs_basemat[ii,],epsilon_artvec[ii],
                      betagvec[ii]),stochastic)
      
      # Infections caused by GBM - BAseline
      infectsgBase[vecIndex,] <- popinfects(popsizemat[ii,]*(1-prop_mvec[ii]-prop_fvec[ii]),rep(infect_prob(gbmactsvec[ii],gbmcondomvec[ii],
                      epsilon_condomvec[ii],prop_art_basemat[ii,1],prop_vs_basemat[ii,1],epsilon_artvec[ii],
                      betagvec[ii]),runyears),stochastic)
      
      # Cost of providing ART
      costAtras[vecIndex,] <- popsizemat[ii,]*(costcarevec[ii]+costartvec[ii])
      
    }
  }

  paramSet <- t(paramSet) # Transpose to align with rows of the output matrices
  
  # Reshape the simulation output into a dataframe so it is easier for analysis and plotting. 
  maleInfects <- melt(t(infectsm)); maleInfects <-maleInfects[c(2,1,3)]; colnames(maleInfects) <- c("simulation","year","infectsbymales")
  femaleInfects <- melt(t(infectsf)); femaleInfects <- femaleInfects[c(2,1,3)]; colnames(femaleInfects) <- 
    c("simulation","year","infectsbyfemales") 
  gbmInfects <- melt(t(infectsg)); gbmInfects <- gbmInfects[c(2,1,3)]; colnames(gbmInfects) <- c("simulation","year","infectsbygbm")
  
  maleInfectsBase <- melt(t(infectsmBase)); maleInfectsBase <-maleInfectsBase[c(2,1,3)]; colnames(maleInfectsBase) <- c("simulation","year","infectsbymalesbase")
  femaleInfectsBase <- melt(t(infectsfBase)); femaleInfectsBase <- femaleInfectsBase[c(2,1,3)]; colnames(femaleInfectsBase) <- 
    c("simulation","year","infectsbyfemalesbase") 
  gbmInfectsBase <- melt(t(infectsgBase)); gbmInfectsBase <- gbmInfectsBase[c(2,1,3)]; colnames(gbmInfectsBase) <- c("simulation","year","infectsbygbmbase")
  
  costAtrasVec <- melt(t(costAtras)); costAtrasVec <- costAtrasVec[c(2,1,3)]; colnames(costAtrasVec) <- c("simulation","year","costatras")
  
  # Merge the results we want into one data frame, order simulations and append parameterset number. Each observation represents a 
  # single calculation of incidence
  newinfections <- merge(maleInfects,femaleInfects,all=TRUE)
  newinfections <- merge(newinfections,gbmInfects,all=TRUE)
  newinfections$totalinfects <- newinfections$infectsbymales + newinfections$infectsbyfemales + newinfections$infectsbygbm
  
  # Baseline results
  newinfections <- merge(newinfections,maleInfectsBase,all=TRUE)
  newinfections <- merge(newinfections,femaleInfectsBase,all=TRUE)
  newinfections <- merge(newinfections,gbmInfectsBase,all=TRUE)
  newinfections$totalinfectsbase <- newinfections$infectsbymalesbase + newinfections$infectsbyfemalesbase + newinfections$infectsbygbmbase
  
  # Averted infections
  newinfections$infectsaverted <- (newinfections$totalinfectsbase - newinfections$totalinfects)
  
  # Costs
  newinfections <- merge(newinfections,costAtrasVec,all=TRUE)
  newinfections$lifecostbase <- newinfections$totalinfectsbase * costlifevec
  newinfections$lifecostatras <- newinfections$totalinfects * costlifevec

  # Order by simulation number
  newinfections <- newinfections[order(newinfections$simulation),]
  
  # Add parameterset number and reorder to put in first column
  newinfections$paramset <- t(paramSet) 
  newinfections <- newinfections[,c(ncol(newinfections),1:(ncol(newinfections)-1))] 
  
  # Subtract a year from year column to start things at year zero
  newinfections$year <- newinfections$year - 1
  
  # Write results to file
  # Save all the internal variables and parameter values 
  if (saveResults){
      save(newinfections, file = paste(outputFolder, "/", currTime, saveFileTag, " Results.R", sep =""))
      write.csv(newinfections, file = paste(outputFolder, "/", currTime, saveFileTag, " Results.csv", sep =""))
    }
} else {
  # Load previously generated results
  load(paste(loadFileTag," Results.R",sep=""))
}

```

### Results

<!--- This section contains code converting the calculation results into figures and summary statistics. Results are then written up using
the calculated values-->

```{r analysis, echo=FALSE,messages = FALSE,include=FALSE}
# Do some data manipulation for producing the cumulative number of infections and infections averted.
infects <- melt(newinfections,id.vars=c("year","simulation"),measure.vars=c("totalinfectsbase","totalinfects"),variable.name="scenario",value.name="newinfections")
infectsSum <- aggregate(newinfections ~ simulation + scenario, data=infects, FUN=sum)

avertedinfects <- melt(newinfections,id.vars=c("year","simulation"),measure.vars=c("infectsaverted"),variable.name="scenario",value.name="totalaverted")
avertedSum <- aggregate(totalaverted ~ simulation + scenario, data=avertedinfects, FUN=sum)

costs <- melt(newinfections,id.vars=c("year","simulation"),measure.vars=c("costatras","lifecostbase","lifecostatras"),
              variable.name="scenario",value.name="totalcost")
costsSum <- aggregate(totalcost ~ simulation + scenario, data=costs, FUN=sum)

# Basic summary calculations 

# Median number of infections at enrolment and after 5 years.
startinfects <- newinfections$totalinfects[newinfections$year == 0]
endinfects <- newinfections$totalinfects[newinfections$year == 5]
startinfectsbase <- newinfections$totalinfectsbase[newinfections$year == 0]
endinfectsbase <- newinfections$totalinfectsbase[newinfections$year == 5]

# Median infections averted
avertmed <- median(avertedSum$totalaverted)
avertiqr <- IQR(avertedSum$totalaverted)

# Costs
medacost <- median(costsSum$totalcost[costsSum$scenario == "costatras"])
iqracost <- IQR(costsSum$totalcost[costsSum$scenario == "costatras"])
medlbcost <- median(costsSum$totalcost[costsSum$scenario == "lifecostbase"])
iqrlbcost <- IQR(costsSum$totalcost[costsSum$scenario == "lifecostbase"])
medlacost <- median(costsSum$totalcost[costsSum$scenario == "lifecostatras"])
iqrlacost <- IQR(costsSum$totalcost[costsSum$scenario == "lifecostatras"])

medtotcost <- median(costsSum$totalcost[costsSum$scenario == "costatras"] + costsSum$totalcost[costsSum$scenario == "lifecostatras"])
iqrtotcost <- IQR(costsSum$totalcost[costsSum$scenario == "costatras"] + costsSum$totalcost[costsSum$scenario == "lifecostatras"])

```

At the time of enrolment for ATRAS the incidence in partners of Medicare ineligible people is `r median(startinfects)` (IQR:`r median(startinfects)-IQR(startinfects)/2` - `r median(startinfects)+IQR(startinfects)/2`). AS a percentage of the infected this number of new infections equates to `r round(100*median(startinfects)/median(popsizemat[,1]),1)`% of the population (Figure 1). In comparison in 2013 there was an estimated 26,640 PLHIV in Australia overall (with 9.4% unidagnosed) and an estimated 912 new infections [@jamespaper]. This equates to `r round(100*912/26640,1)`% rate of new infections per population living with HIV. According to recent estimates of the HIV treatment and cascade 17,661 PLHIV received ART in 2013 (approximatley 66% of the overall number of PLHIV) with 93% having an undetectable viral load [@jwilsoncascade]. Nationally this means 62% of the overall population of PLHIV have viral suppression (compared to 43% of the ATRAS cohort at enrolement). Using the national estimates for viral suppression we obtain an incidence rate 6.6% per population of Medicare ineligbles. 

The impact of expanding ATRAS to all Medicare ineligbiles and acheiving almost universal viral suppression is to reduce annual new infections to 
`r median(endinfects)` (IQR:`r median(endinfects)-IQR(endinfects)/2` - `r median(endinfects)+IQR(endinfects)/2`) after 5 years (Figure 1).  Corresponding to `r round(100*median(endinfects)/median(popsizemat[,5]),)`% of the Medicare ineligible population. 
 
```{r plotcode, echo=FALSE,messages = FALSE,include=FALSE}
# Create plots of results
graphics.off()

# Initialize plotting properties
colourmap <- c("#999999","#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") # Colour blind palette with grey and black 

# Theme for plot variables
opts <- theme(text = element_text(face = "bold",size=12,colour="black"),
  axis.text.x = element_text(face = "plain",size=10,colour="black"),
  axis.text.y = element_text(face = "plain",size=10,colour="black"),
  axis.line = element_line(colour="black"),
  axis.ticks = element_line(colour="black"),
  legend.position = "top",
  legend.background = element_rect(),
  legend.key = element_blank(),
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(), 
  panel.background = element_blank(), 
  axis.line = element_line(colour = "black")
)

simsplot <- ggplot(data = newinfections,aes(x=year,group=simulation)) + theme_bw() # Setup data for plot
simsplot <- simsplot + geom_line(aes(y = totalinfectsbase,colour="Baseline simulations"),size = 1.05) # Plot baseline simulations
simsplot <- simsplot + geom_line(aes(y = totalinfects,colour="ATRAS simulations"),size = 1.05) # ATRAS simulations
simsplot <- simsplot + stat_summary(aes(y=totalinfectsbase,group=1),fun.y = median,geom = "line",colour=colourmap[2],size = 1.2) # Median of baseline simulations
simsplot <- simsplot + stat_summary(aes(y=totalinfects,group=1),fun.y = median,geom = "line",colour=colourmap[7],size = 1.2) # Median of ATRAS simulation
simsplot <- simsplot + scale_colour_manual("",breaks = c("Baseline simulations","ATRAS simulations"), values = c(colourmap[4],colourmap[1]))
simsplot <- simsplot + ylim(0,round(max(newinfections$totalinfects,newinfections$totalinfectsbase),-1))
simsplot <- simsplot + xlab("Years since start of ATRAS") + ylab("New infections") + opts

# Create a boxplot for cumulative incidence
totalplot <- ggplot(data = infectsSum,aes(x=scenario,y=newinfections)) +  theme_bw() + geom_boxplot(aes(fill=scenario),width = 0.75,alpha = 0.5)
totalplot <- totalplot + scale_fill_manual(labels=c("Baseline","ATRAS"),values = c(colourmap[2],colourmap[7]))
totalplot <- totalplot + xlab("") + ylab("Cumulative infections") + scale_colour_manual(labels=c("Baseline","ATRAS"),values = c(colourmap[2],colourmap[7])) + scale_x_discrete(labels=c("Baseline","ATRAS")) 
totalplot <- totalplot + opts + theme(legend.position="none")

# Histogram of averted infections
avertplot <- ggplot(data = avertedSum,aes(x=totalaverted)) + theme_bw()
avertplot <- avertplot + geom_density(alpha = 0.5, fill = colourmap[7])
avertplot <- avertplot + xlab("Infections averted") + ylab("Density")
avertplot <- avertplot + opts + theme(legend.position="none")

# Create a plot for total costs 
costplot <- ggplot(data = costsSum,aes(x=scenario,y=totalcost/1e6)) + theme_bw() + stat_summary(fun.y="median", geom="bar",
                   aes(fill=scenario,width=0.5),alpha = 0.5)
costplot <- costplot + scale_fill_manual(values = c(colourmap[7],colourmap[2],colourmap[7]))
costplot <- costplot + stat_summary(fun.data="median_hilow",conf.int = 0.75, geom="errorbar",width = 0.2,size=1.1)
costplot <- costplot + xlab("") + ylab("Total cost (millions AUD)") + scale_x_discrete(labels=c("ATRAS costs","Lifetime costs \n new infections \n Baseline","Lifetime costs \n new infections \n ATRAS")) 
costplot <- costplot + opts + theme(legend.position="none")

# Show plots in separate windows and save to file if requested
if (showPlots || savePlots){windows(width=6,height=4.5); print(simsplot)}
if (savePlots){dev.print(pdf,file=paste(outputFolder, "/figures/", currTime, " Results_Sims", saveFileTag,".pdf",sep =""))}
if (showPlots || savePlots){windows(width=12,height=4.5); print(grid.arrange(totalplot,avertplot,ncol = 2))}
if (savePlots){dev.print(pdf,file=paste(outputFolder, "/figures/", currTime, " Results_Total", saveFileTag,".pdf",sep =""))}
if (showPlots || savePlots){windows(width=6,height=4.5); print(costplot)}
if (savePlots){dev.print(pdf,file=paste(outputFolder, "/figures/", currTime, " Results_Costs", saveFileTag,".pdf",sep =""))}


```

**Figure 1** - Annual new infections in partners of Medicare ineligibles for each simulation. The grey lines represent the baseline simulations while the blue lines are for the expansion of ART to all Medicare ineligibles. The black and dark blue lines show the median number of new infections for the Baseline and expanded ATRAS simulations respectively.   

```{r insertyplots1, echo=FALSE, messages = FALSE, warning = FALSE, fig.width=4, fig.height=3}
if(knitplots){print(simsplot)}
```

Figure 2 shows the distributions for the cumulative number of new infections in partners of Medicare ineligibles for the baseline scenario and if ART is succesfully provided to all Medicare ineligibles. Providing treatment to all Medicare ineligibles will avert a median of `r avertmed`  new infections (IQR: `r avertmed-avertiqr/2` - `r avertmed+avertiqr/2`).

**Figure 2** - Total number of number of new infections (left) and the distribution in infections averted (right) over 5 years since the exapansion of ATRAS. 

```{r insertyplots2, echo=FALSE, messages = FALSE, warning = FALSE, fig.width=6, fig.height=3}
if(knitplots){print(grid.arrange(totalplot,avertplot,ncol = 2))}
```

Figure 3 shows the cumulative costs for providing ART to Medicare ineligible people and the resulting lifetime cost of providing care and treatment to the partners infected during this period. Providing ART to Medicare ineligibles over 5 years is estimated to a median cost of \$`r formatC(round(medacost,-4),format="d",big.mark=',')` (IQR: \$`r formatC(round(medacost -iqracost/2,4),format="d",big.mark=',')` - \$`r formatC(round(medacost + iqracost/2,4),format="d",big.mark=',')`). For partners who become infected during this time the undisconted cost for providing them with care and treatment over the rest of their life is \$`r formatC(round(medlacost,4),format="d",big.mark=',')` (IQR: \$`r formatC(round(medlacost -iqrlacost/2,4),format="d",big.mark=',')` - \$`r formatC(round(medlacost + iqrlacost/2,4),format="d",big.mark=',')`). Adding the cost of providing treatment to Medicare ineligibles to the lifetime care cost for newly infected partners for each simulation and taking the median gives an estimated cost of \$`r formatC(round(medlacost,4),format="d",big.mark=',')` (IQR: \$`r formatC(round(medtotcost -iqrtotcost/2,4),format="d",big.mark=',')` - \$`r formatC(round(medtotcost + iqrtotcost/2,4),format="d",big.mark=',')`). This cost is lower than the cost of providing care and treatment to newly infected people over their lifetime under the baseline scenario 
(median \$`r formatC(round(medlbcost,4),format="d",big.mark=',')`:IQR \$`r formatC(round(medlbcost -iqrlbcost/2,4),format="d",big.mark=',')` - \$`r formatC(round(medlbcost + iqrlbcost/2,4),format="d",big.mark=',')`). Providing ART to Medicare ineligibles results in a saving over the longterm. 

**Figure 3** - Median total costs for providing all Medicare ineligbles with ART and the lifetime care and treatment costs for partners of Medicare Ineligibles who become infected. The bars show the interquartile range in total costs across all simulations.

```{r insertyplots3, echo=FALSE, messages = FALSE, warning = FALSE, fig.width=6, fig.height=3}
if(knitplots){print(costplot)}
```

```{r tidyup,echo = FALSE}
options(scipen=0)  # Set back to default
```

### References





